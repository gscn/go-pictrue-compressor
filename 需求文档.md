# Linux命令行图片压缩工具需求文档

## 1. 概述

使用golang开发一款高效的Linux命令行图片压缩工具，用于批量处理指定目录下的图片文件，提供灵活的压缩选项，同时确保资源使用效率和操作可追溯性。

## 2. 功能需求

### 2.1 核心功能

1. **图片压缩**：
   - 支持常见图片格式（JPEG, PNG, WebP等）
   - 提供宽度限制选项，等比缩放（仅当原图宽度大于指定宽度时）
   - 提供可选的图片质量参数（默认75%）
   - 支持大小过滤（仅处理大于指定大小的原图）

2. **文件处理**：
   - 保留原始文件路径、名称和格式
   - 仅当压缩后文件更小时才替换原文件
   - 自动跳过无法处理的文件类型

3. **资源管理**：
   - 限制并发处理数量以防止资源耗尽
   - 实现高效的内存和磁盘使用策略
   - 提供处理进度反馈

4. **日志记录**：
   - 记录每次处理的详细信息
   - 支持日志文件轮转

### 2.2 命令行参数

| 参数 | 缩写 | 必选 | 类型 | 描述 | 默认值 |
|------|------|------|------|------|--------|
| `--directory` | `-d` | 是 | 字符串 | 要处理的目录路径 | 无 |
| `--max-width` | `-w` | 是 | 整数 | 最大宽度（像素） | 无 |
| `--quality` | `-q` | 否 | 整数(1-100) | 压缩质量 | 75 |
| `--min-size` | `-s` | 否 | 字符串 | 最小处理大小（如5M, 1G） | 0 |
| `--threads` | `-t` | 否 | 整数 | 最大并发线程数 | CPU核心数/2 |
| `--log-file` | `-l` | 否 | 字符串 | 日志文件路径 | ./imgcompress.log |
| `--help` | `-h` | 否 | 无 | 显示帮助信息 | false |

### 2.3 日志格式

每行日志包含以下字段（CSV格式）：
```
timestamp, file_path, original_size, processed_size, action_taken, processing_time, status
```

字段说明：
- `timestamp`: ISO 8601格式时间戳
- `file_path`: 文件完整路径
- `original_size`: 原始文件大小（字节）
- `processed_size`: 处理后文件大小（字节，如未处理则为空）
- `action_taken`: "compressed", "skipped"（不满足条件）, "replaced"（替换原文件）, "failed"
- `processing_time`: 处理耗时（毫秒）
- `status`: "success"或错误信息

## 3. 非功能需求

### 3.1 性能需求
- 单线程处理时CPU占用不超过80%
- 内存使用不超过200MB基础+每线程50MB
- 支持中断恢复（通过日志记录已处理文件）

### 3.2 兼容性需求
- 支持Linux主流发行版（Ubuntu, CentOS, Debian等）
- 编译为独立二进制

### 3.3 安全性需求
- 处理前验证文件权限
- 不跟随符号链接
- 保留原文件权限属性

## 4. 技术方案

### 4.1 推荐实现方案

**Python实现方案**：
- 使用Pillow库进行图像处理
- 使用multiprocessing实现并行处理
- 使用argparse处理命令行参数
- 内置日志轮转功能

**备选方案**：
- Rust实现（更高性能，更复杂开发）
- 调用外部工具如ImageMagick（增加依赖）

### 4.2 处理流程

1. 参数验证和初始化
2. 递归扫描目录，构建文件列表
3. 过滤不符合条件的文件（大小、类型）
4. 并行处理队列：
   - 读取文件
   - 检查是否需要缩放
   - 应用压缩
   - 比较大小
   - 决定是否替换
5. 记录结果
6. 生成摘要报告

## 5. 异常处理

- 无效图片文件：记录并跳过
- 权限不足：记录并跳过
- 磁盘空间不足：中止处理并报警
- 处理超时（单文件>30秒）：中止该文件处理

## 6. 输出示例

**命令行输出**：
```
图片压缩工具 v1.0
扫描目录: /var/www/images
找到图片文件: 342个
符合条件待处理: 128个
开始处理（使用4线程）...

[====================] 100% 128/128
处理完成:
- 成功压缩: 112个
- 替换原文件: 98个
- 跳过: 16个
- 失败: 0个
节省空间: 45.7MB
详细日志见: /var/log/imgcompress.log
```

**日志示例**：
```
2023-08-20T14:23:45Z,/var/www/images/photo1.jpg,5242880,3123456,replaced,1420,success
2023-08-20T14:23:46Z,/var/www/images/small.png,102400,,skipped,12,size_too_small
```

## 7. 测试计划

1. 单元测试：
   - 参数解析验证
   - 单文件压缩逻辑
   - 大小比较逻辑

2. 集成测试：
   - 目录递归扫描
   - 并发处理
   - 日志记录

3. 性能测试：
   - 大文件（>10MB）处理
   - 高并发场景
   - 长时间运行测试

## 8. 后续优化方向

1. 支持更多图片格式（如AVIF）
2. 添加智能压缩模式（自动选择最佳参数）
3. 支持分布式处理
4. 添加目录监控模式（持续处理新文件）

## 附录A：示例命令

基本用法：
```bash
imgcompress -d /path/to/images -w 1920
```

完整参数：
```bash
imgcompress -d /path/to/images -w 1920 -q 85 -s 1M -t 4 -l /var/log/mycompress.log
```

试运行：
```bash
imgcompress -d /path/to/images -w 1080 -n
```